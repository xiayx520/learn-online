# 课程作业功能实现逻辑

## 功能需求

在学习界面中，当用户点击"课程作业"按钮时，需要展示该课程的课程计划所绑定的作业信息。

## 数据模型

通过分析代码，我们发现以下与课程作业相关的核心实体：

### 1. WorkInfo (作业基本信息)
```java
@Data
@TableName("work_info")
public class WorkInfo {
    @TableId(value = "id", type = IdType.AUTO)
    private Long id;
    // 作业标题
    private String title;
    // 作业描述
    private String description;
    // 作业状态：draft-草稿，published-已发布，archived-已归档
    private String status;
    // 创建人
    @TableField("create_user")
    private Long createUser;
    // 创建时间
    @TableField("create_date")
    private LocalDateTime createDate;
    // 修改时间
    @TableField("change_date")
    private LocalDateTime changeDate;
    // 提交人数
    private Integer userNum;
}
```

### 2. TeachplanWork (课程计划与作业的绑定关系)
```java
@Data
@TableName("teachplan_work")
public class TeachplanWork {
    @TableId(value = "id", type = IdType.AUTO)
    private Long id;
    private Long workId;
    private String workTitle;
    private Long teachplanId;
    private Long courseId;
    private Long coursePubId;
    private LocalDateTime createDate;
}
```

### 3. Teachplan (课程计划)
```java
@Data
@TableName("teachplan")
public class Teachplan implements Serializable {
    @TableId(value = "id", type = IdType.AUTO)
    private Long id;
    // 课程计划名称
    private String pname;
    // 课程计划父级Id
    private Long parentid;
    // 层级，分为1、2、3级
    private Integer grade;
    // 课程类型:1视频、2文档
    private String mediaType;
    // 开始直播时间
    private LocalDateTime startTime;
    // 直播结束时间
    private LocalDateTime endTime;
    // 章节及课程时介绍
    private String description;
    // 时长，单位时:分:秒
    private String timelength;
    // 排序字段
    private Integer orderby;
    // 课程标识
    private Long courseId;
    // 课程发布标识
    private Long coursePubId;
    // 状态（1正常  0删除）
    private Integer status;
    // 是否支持试学或预览（试看）
    private String isPreview;
    // 创建时间
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createDate;
    // 修改时间
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime changeDate;
}
```

## 后端实现逻辑

### 1. 添加VO类

创建了`TeachplanWorkVO`类，继承自`TeachplanWork`，添加`WorkInfo`属性：

```java
@Data
public class TeachplanWorkVO extends TeachplanWork {
    // 作业详细信息
    private WorkInfo workInfo;
}
```

修改`TeachPlanVO`类，添加作业关联：

```java
@Data
public class TeachPlanVO extends Teachplan {
    //课程计划媒资信息
    private TeachplanMedia teachplanMedia;
    //课程计划作业信息
    private TeachplanWorkVO teachplanWork;
    //子节点
    private List<TeachPlanVO> teachPlanTreeNodes;
}
```

### 2. 添加Mapper接口方法

在`TeachplanWorkMapper`接口中添加方法：

```java
@Mapper
public interface TeachplanWorkMapper extends BaseMapper<TeachplanWork> {
    /**
     * 根据课程ID查询课程计划关联的作业信息
     * @param courseId 课程ID
     * @return 课程计划作业关联信息列表
     */
    List<TeachplanWorkVO> getTeachplanWorksByCourseId(@Param("courseId") Long courseId);
}
```

对应的XML配置：

```xml
<!-- 根据课程ID查询课程计划关联的作业信息 -->
<select id="getTeachplanWorksByCourseId" resultMap="TeachplanWorkVOMap">
    SELECT 
        tw.id,
        tw.work_id,
        tw.work_title,
        tw.teachplan_id,
        tw.course_id,
        tw.course_pub_id,
        tw.create_date,
        wi.id as work_info_id,
        wi.title,
        wi.description,
        wi.status,
        wi.create_user,
        wi.create_date,
        wi.change_date,
        wi.user_num
    FROM 
        teachplan_work tw
    LEFT JOIN 
        work_info wi ON tw.work_id = wi.id
    WHERE 
        tw.course_id = #{courseId}
</select>
```

### 3. 添加Service方法

在`TeachPlanService`接口中添加方法：

```java
/**
 * 获取课程计划树形结构，包含作业信息
 * @param courseId 课程id
 * @return 课程计划树形结构(包含作业信息)
 */
List<TeachPlanVO> getTeachPlanTreeWithWork(Long courseId);
```

实现类中的代码：

```java
@Override
public List<TeachPlanVO> getTeachPlanTreeWithWork(Long courseId) {
    // 获取课程计划基本结构
    List<TeachPlanVO> teachPlanTree = getTeachPlanTree(courseId);
    
    // 获取课程关联的所有作业信息
    List<TeachplanWorkVO> teachplanWorks = teachplanWorkMapper.getTeachplanWorksByCourseId(courseId);
    
    // 将作业信息关联到对应的课程计划中
    if (teachPlanTree != null && !teachPlanTree.isEmpty() && teachplanWorks != null && !teachplanWorks.isEmpty()) {
        // 为每个课程计划节点关联作业信息
        associateWorkWithTeachplan(teachPlanTree, teachplanWorks);
    }
    
    return teachPlanTree;
}

/**
 * 递归关联作业与课程计划
 * @param teachPlanNodes 课程计划节点
 * @param teachplanWorks 作业信息列表
 */
private void associateWorkWithTeachplan(List<TeachPlanVO> teachPlanNodes, List<TeachplanWorkVO> teachplanWorks) {
    if (teachPlanNodes == null || teachplanWorks == null) {
        return;
    }
    
    for (TeachPlanVO teachPlanNode : teachPlanNodes) {
        // 只有小节(grade=2)才能关联作业
        if (teachPlanNode.getGrade() == 2) {
            // 查找对应的作业信息
            for (TeachplanWorkVO teachplanWork : teachplanWorks) {
                if (teachPlanNode.getId().equals(teachplanWork.getTeachplanId())) {
                    teachPlanNode.setTeachplanWork(teachplanWork);
                    break;
                }
            }
        }
        
        // 递归处理子节点
        List<TeachPlanVO> childNodes = teachPlanNode.getTeachPlanTreeNodes();
        if (childNodes != null && !childNodes.isEmpty()) {
            associateWorkWithTeachplan(childNodes, teachplanWorks);
        }
    }
}
```

### 4. 添加Controller接口

创建了专门的`CourseWorkController`类：

```java
@RestController
@Slf4j
@RequestMapping("/course-work")
@Api(tags = "课程作业管理")
public class CourseWorkController {

    @Autowired
    private TeachPlanService teachPlanService;

    /**
     * 获取课程计划及关联的作业信息
     * @param courseId 课程ID
     * @return 课程计划及作业信息
     */
    @GetMapping("/{courseId}")
    @ApiOperation("获取课程计划及关联的作业信息")
    public List<TeachPlanVO> getCourseWorkInfo(@PathVariable Long courseId) {
        log.info("获取课程[{}]的作业信息", courseId);
        return teachPlanService.getTeachPlanTreeWithWork(courseId);
    }
}
```

## 前端实现逻辑

### 1. 添加HTML结构

在`learning.html`页面中添加课程作业区域，并创建了相关的模板：

```html
<!-- 课程作业展示区域 开始 -->
<div id="artcleWork" class="article-cont">
    <div class="article-left-box">
        <div class="content">
            <div class="content-title">
                <p><a class="all" href="javascript:void(0)">课程作业</a></p>
            </div>
            <div class="content-com course-work-list">
                <div class="no-data" style="display: none;">
                    <p>该课程暂无作业</p>
                </div>
                <div class="work-list-container">
                    <!-- 作业列表将在这里动态生成 -->
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 课程作业展示区域 结束 -->
```

同时添加了3个模板用于渲染作业项、提交表单和查看作业详情：
- `work-item-template`: 作业列表项模板
- `work-submit-template`: 作业提交表单模板
- `work-view-template`: 作业查看模板

### 2. 添加CSS样式

创建了`course-work.css`文件，定义了课程作业相关的样式：
- 作业列表样式
- 作业状态标识样式
- 提交和查看作业按钮样式
- 模态框样式
- 表单样式

```css
/* 部分样式示例 */
.work-item {
    border: 1px solid #e6e6e6;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 20px;
    background-color: #fff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: all 0.3s;
}

.work-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 10px;
}

.work-status {
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 12px;
    color: #fff;
}

.work-status.draft { background-color: #8c8c8c; }
.work-status.published { background-color: #52c41a; }
.work-status.archived { background-color: #1890ff; }
```

### 3. 添加JavaScript功能

创建了`course-work.js`文件，实现以下功能：

1. **初始化**：
   ```javascript
   $(function() {
       // 获取当前课程ID
       const courseId = getQueryVariable('id');
       
       // 初始化
       if (courseId) {
           initCourseWork(courseId);
       }

       // 事件绑定
       $(document).on('click', '.btn-submit-work', handleSubmitWorkClick);
       $(document).on('click', '.btn-view-work', handleViewWorkClick);
       $(document).on('click', '.btn-cancel, .btn-close', closeModal);
       $(document).on('click', '.modal-backdrop', closeModal);
       $(document).on('click', '.work-submit-form .btn-submit', submitWorkContent);
   });
   ```

2. **数据获取**：
   ```javascript
   function getCourseWorkData(courseId) {
       return new Promise((resolve, reject) => {
           $.ajax({
               url: `http://www.51xuecheng.cn/api/content/course-work/${courseId}`,
               type: 'GET',
               success: function(response) {
                   resolve(response);
               },
               error: function(xhr, status, error) {
                   reject(error);
               }
           });
       });
   }
   ```

3. **数据处理**：
   ```javascript
   function extractWorkItems(teachplans) {
       let workItems = [];
       
       function extractFromNode(node, parentName = '') {
           // 如果是小节且有关联作业
           if (node.grade === 2 && node.teachplanWork) {
               workItems.push({
                   workId: node.teachplanWork.workId,
                   teachplanId: node.id,
                   workTitle: node.teachplanWork.workTitle,
                   chapterName: `${parentName} > ${node.pname}`,
                   description: node.teachplanWork.workInfo ? node.teachplanWork.workInfo.description : '',
                   status: node.teachplanWork.workInfo ? node.teachplanWork.workInfo.status : 'draft'
               });
           }
           
           // 处理子节点
           if (node.teachPlanTreeNodes && node.teachPlanTreeNodes.length > 0) {
               const currentParentName = node.grade === 1 ? node.pname : parentName;
               node.teachPlanTreeNodes.forEach(child => {
                   extractFromNode(child, currentParentName);
               });
           }
       }
       
       // 遍历课程计划树
       teachplans.forEach(node => {
           extractFromNode(node);
       });
       
       return workItems;
   }
   ```

4. **渲染功能**：
   ```javascript
   function renderCourseWorkList(data) {
       const $container = $('.work-list-container');
       $container.empty();
       
       // 处理数据，提取所有具有作业的课程计划
       let hasWorks = false;
       const workItems = extractWorkItems(data);
       
       if (workItems.length > 0) {
           hasWorks = true;
           // 渲染每个作业项
           workItems.forEach(item => {
               const workTemplate = getWorkItemHtml(item);
               $container.append(workTemplate);
           });
       }
       
       // 显示或隐藏无数据提示
       if (hasWorks) {
           $('.no-data').hide();
       } else {
           showNoDataMessage();
       }
   }
   ```

5. **交互功能**：
   - 提交作业功能
   - 查看作业详情功能
   - 模态框交互

### 4. 文件引入

在`learning.html`页面中引入CSS和JS文件：

```html
<!-- 引入CSS -->
<link rel="stylesheet" href="http://www.51xuecheng.cn/css/course-work.css" />

<!-- 引入JS -->
<script type="text/javascript" src="http://www.51xuecheng.cn/js/course-work.js"></script>
```

## 实现功能总结

通过以上实现，我们完成了以下功能：

1. **后端功能**：
   - 创建VO对象，封装课程计划和作业的关联关系
   - 实现根据课程ID查询课程计划和关联作业的数据库操作
   - 实现将作业信息关联到课程计划的业务逻辑
   - 提供获取课程作业信息的REST API接口

2. **前端功能**：
   - 创建作业展示区域，对应`#artcleWork`锚点
   - 实现从后端获取课程作业数据的逻辑
   - 提供作业列表展示、提交作业和查看作业详情的功能
   - 实现友好的用户交互体验

## 流程总结

1. 用户点击"课程作业"链接，跳转到学习页面的作业区域（`#artcleWork`锚点）
2. 前端JS根据课程ID调用后端接口获取课程计划及作业信息
3. 前端解析数据，从课程计划树中提取作业信息并渲染显示
4. 用户可以查看作业详情或提交作业内容
5. 提交的作业内容通过Ajax请求发送到后端处理
6. 后端保存作业提交记录并返回结果

至此，完成了课程作业功能的前后端实现。 